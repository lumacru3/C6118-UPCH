---
title: "Análisis de las condiciones del océano frente a Perú durante el año 1990 - Tercer Examen Programación Científica"
author: "Lucía Maldonado Cruzado"
date: "6 de Julio del 2017"
output: html_document
keep_md: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r kali, eval=FALSE, echo=FALSE, include=FALSE}
install.packages("devtools")
devtools::install_github("roliveros-ramos/kali")
```


```{r, echo=FALSE, include=FALSE }

library(ncdf4)
library(fields)
library(kali)

data_sst = nc_open("datos/sst.nc4")
data_sss = nc_open("datos/sss.nc4")
data_lphy = nc_open("datos/lphy.nc4")
data_sphy = nc_open("datos/sphy.nc4")
# Definir variables generales -------------------------------------------------------

sst = ncvar_get(data_sst, "to")
sss = ncvar_get(data_sss, "so")
lat = ncvar_get(data_sst, "latitude")
lon = ncvar_get(data_sst, "longitude") - 360
time = ncvar_get(data_sst, "time")
time2 = ncvar_get(data_lphy, "time")
time2 = time
lphy = ncvar_get(data_lphy, "intpp")
sphy = ncvar_get(data_sphy, "intpp")
sfito = sphy * 10^6
lfito = lphy * 10^6
totalfito = sfito + lfito

# SOLO DATOS 1990 ---------------------------------------------------------------

t1990 = time[361:372]
sst1990 = sst[,,361:372]
sss1990 = sss[,,361:372]
lphy1990 = lfito[,,361:372]
sphy1990 = sfito[,,361:372]
fito1990 = totalfito[,,361:372]

#PROMEDIO DATOS 1990

promsst90 = apply(sst1990, MARGIN = c(1,2), FUN=mean)
promsss90 = apply(sss1990, MARGIN = c(1,2), FUN=mean)
promlphy90 = apply(lphy1990, MARGIN = c(1,2), FUN=mean)
promsphy90 = apply(sphy1990, MARGIN = c(1,2), FUN=mean)
promtodofito = apply(fito1990, MARGIN = c(1,2), FUN=mean)

#PROMEDIO DATOS TOTAL 1959 - 2005

promsst = apply(sst, MARGIN = c(1,2), FUN=mean)
promsss = apply(sss, MARGIN = c(1,2), FUN=mean)
promlphy = apply(lfito, MARGIN = c(1,2), FUN=mean)
promsphy = apply(sfito, MARGIN = c(1,2), FUN=mean)

#ANOMALIAS 1990 CON RESPECTO A PROMEDIO TOTAL

anomsst90 = promsst - promsst90
anomsss90 = promsss - promsss90
anomlphy90 = promlphy - promlphy90
anomsphy90 = promsphy - promsphy90

```

# Introducción

Se realizó el análisis de las condiciones oceánicas frente a las costas de Perú durante el año 1990. Se utilizaron datos de temperatura superficial del mar (TSM), salinidad en UPS y fitoplancton pequeño y grande (micromol por metro cuadrado por segundo). Los gráficos se realizaron con Rstudio. 


# Materiales y métodos

Para lograr realizar los gráficos que caracterizan las costas de Perú durante 1990 se proporcionaron 4 bases de datos. La propiedad que mejor describe el ecosistema costero es la temperatura superficial del mar que se extrajo del archivo "sst.nc4" como temperatura potencial superficial. Las unidades se encontraban en grados celcius por lo que no se tuvo que hacer ninguna conversión. De este mismo archivo de temperaturas se extrajeron los márgenes de latitud y longitud que se recortaron para realizar solo el análisis en el mar peruano. 

La serie de tiempo de datos proporcionada contiene 30 años de información desde el año 1959 hasta el año 2005 en la unidad de meses. Debido a que el análisis se realizó solo del año 1990 se tuvieron que extraer los parámetros dentro de los 12 meses de 1990 (361:372, ya que la serie de meses iniciaba en 0 hasta 552). El parámetro de tiempo del archivo de temperatura también se usó para los siguientes gráficos.

El archivo sss.nc4 se utilizó para extraer los datos de salinidad en unidades UPS. Posteriormente se obtuvieron los datos de fitoplancton de los archivos lphy.c4 y sphy.nc4 que tuvieron que ser modificados para obtener la abundancia de fitoplancton en micromoles por metro cuadrado al segundo. 

# Resultados 

##Análisis Temperatura Superficial del Mar

El Perú es un país que se encuentra en una zona tropical, sin embargo no posee un clima tropical lo que se debe a la temperatura del mar que influencia la temperatura del aire y a su vez crea una atmósfera estable. Esta atmósfera estable se caracteriza por una barrera de nubes que cubre la mayor parte de la costa peruana. Los vientos cálidos no pueden atravesar esta barrera y a su vez esta también refleja gran cantidad de la radiación solar que calentaría el mar. 

Debido a la gran importancia de la regulación atmosférica que posee nuestro mar, su estudio es necesario y es por ello que se toman constantemente medidas de la temperatura del mar a lo largo de series de tiempo muy extensas. En este estudio se concentra la información obtenida en el año 1990.


```{r check, fig.width=5, fig.height=5, fig.cap=" ",echo=FALSE}

par(oma=c(0,0,0,2))

image.map(lon, lat, promsst90, legend.width = 0.6, legend.lab = "°C")
title("Distribución de temperaturas en el año 1990")

```
En el gráfico de distribución de temperaturas en el año 1990 se observa que a lo largo de la costa peruana las temperaturas no sobrepasan los 24°C. y que a partir de la costa central las temperaturas bajan hasta los 20°C y menos. Sim embargo, este resultado podría estár sesgado ya que el promedio de la temperatura total del año contiene tanto los meses de verano, con anomalías cálidas, como los meses de inverno, con anomalías frías. Según la bibliografía el año 1990 presenta anomalías frías predominantes, lo que se espera ver en los siguientes gráficos. 

```{r , fig.width=5, fig.height=5, fig.cap=" ",echo=FALSE, fig.align="center"}

#par(oma=c(0,0,0,2))

image.map(lon, lat, anomsst90, legend.width = 0.6, legend.lab = "°C")
title("Anomalías T° 1990")

```
Cuando comparamos el año 1990 con el resto de los datos proporcionados que abarcan 46 años de nuestreo de TSM, se puede observar una anomalía negativa en el norte de la costa peruana lo que indicaría que es un año con tendencia fría como menciona la bibliografía consultada. 

```{r , fig.width=8, fig.height=6, fig.cap="EVOLUCIÓN MENSUAL DE LA TEMPERATURA DURANTE EL AÑO 1990 ",echo=FALSE, fig.align="center"}
meses = rep(1:12, length=length(t1990))

sst_mes= array(dim=c(dim(sst)[1:2], 12)) 

par(mfrow=c(3,4), mar=c(3,3,3,4)) 

for (i in 1:12){
  sst_mes[,,i] = apply(sst[,, meses==i], MARGIN=c(1,2), FUN=mean, na.rm=TRUE)
  image.map(lon, lat, sst_mes[,,i], main=paste(month.name[i]))
}

```

Cuando vemos el gráfico de las diferencias de temperatura a lo largo de todos los meses del año se observa la estacionalidad bien marcada siendo los meses más fríos los de julio, agosto y setiembre, que vendrían a representar el invierno en el hemisferio sur. A partir del mes de julio se hace evidente este enfriamiento sobretodo a partir de los 10°S llegando a temperaturas de 18°C. 

```{r , fig.width=7, fig.height=3, fig.cap="VARIACIÓN DE TEMPERATURAS EN VERANO 1990 ",echo=FALSE, fig.align="center"}
par(mfrow=c(1,3), mar=c(4,4,2,2)) 

for (i in 1:3){
  sst_mes[,,i] = apply(sst[,, meses==i], MARGIN=c(1,2), FUN=mean, na.rm=TRUE)
  image.map(lon, lat, sst_mes[,,i], main=paste(month.name[i]))
}
```

Como se sabe las costas peruanas son altamente productivas y esto se debe a que se trata de un ecosistema que está influenciado por la surgencia de aguas profundas que traen consigo nutrientes que desecadenan el desarrollo de la producción primaria y por ende impulsan la productividad del ecosistema en general. Una manera de notar la presencia de este levantamiento de aguas profundas es mediante la diferencia de temperaturas en la costa. Al subir estas aguas profundas logran disminuir la temperatura costera, este fenómeno es más evidente en el verano ya que la temperatura promedio de incrementa en los meses de verano (24°C) sin embargo, las aguas de surgencia mantienen una temperatura baja (22°C). 


```{r , fig.width=6, fig.height=4, fig.cap=" Diagrama Hovmoller ",echo=FALSE, fig.align="center"}

RES=sweep(sst1990, c(1,2), promsst, "-") 

par(mfrow=c(1,1))
hov1 = apply(RES, MARGIN = c(2,3), FUN = mean, na.rm = TRUE) #promedio SST en todo el tiempo

Hovmuller1=image.plot(1:12, lat, t(hov1), las=1,ylim=c(-20,0), xlab="Tiempo", ylab="Latitud", axes=FALSE, nlevel=2000, legend.lab = "°C")

title("Anomalías de temperatura a lo largo de 1990")
ejey = paste(abs(axTicks(2)), ifelse(axTicks(2)>0, "°N", "°S"), sep="") 
axis(2, at=axTicks(2), labels=ejey, las=1) 
points(-5,1) #truco para retomar el foco en el eje, se buscará una mejor solución
axis(1, at=1:12, labels=month.name)
box()
```

En el diagrama hovmoller de anomalías a lo largo del año 1990 se puede identificar fácilmente que la mayor anomalía de temperatura se da en el mes de marzo alcanzando más de 3 grados de anomalía. Por otro lado en el mes de setiembre se encuentra la mayor anomalía negativa alcanzando temperaturas con anomalías negativas menores a -2°C.

Las anomalías frías fueron más extensas a lo largo de la costa peruana y también en el tiempo ya que la mayor predominancia en el año es de anomalías frías (desde junio hasta diciembre). Las anomalías positivas fueron más intensas hasta los 10°S y en los meses de marzo y abril.  

##Análisis de Salinidad

```{r , fig.width=5, fig.height=6, fig.cap=" Salinidad promedio y anomalías durante 1990 (UPS) ",echo=FALSE, fig.align="center"}

par(mfrow=c(2,1), mar=c(0,0,0,0), oma=c(5,5,3,3))

image.map(lon, lat, promsss90, legend.lab = "UPS")

image.map(lon, lat, anomsss90, legend.lab = "UPS")

```

El año 1990 presenta una salinidad alta mayor a 35 UPS, sin embargo, para el gráfico de anomalías se observa una ligera anomalía negativa en el promedio, es necesario analizar cada mes para localizar en qué momento del año se desarrolla dicha anomalía.

Esto coincide con la bibliografía que menciona que las salinidades estuvieron por encima de 35.1%. que en general presenta valores altos debido a la predominancia de Aguas Subtropicales Superficiales. La disminución hasta 34.6 que se observa en el siguiente gráfico en el mes de abril podría explicarse con la presencia de aguas costeras frías o también aguas de surgencia.

```{r , fig.width=8, fig.height=7, fig.cap=" Salinidad mensual durante 1990 (UPS) ",echo=FALSE, fig.align="center"}

sss_mes= array(dim=c(dim(sss)[1:2], 12)) 

par(mfrow=c(3,4), mar=c(3,3,3,4)) 

for (i in 1:4){
  sss_mes[,,i] = apply(sss[,, meses==i], MARGIN=c(1,2), FUN=mean, na.rm=TRUE)
  image.map(lon, lat, sss_mes[,,i], main=paste(month.name[i]))
}

for (i in 5:8){
  sss_mes[,,i] = apply(sss[,, meses==i], MARGIN=c(1,2), FUN=mean, na.rm=TRUE)
  image.map(lon, lat, sss_mes[,,i], main=paste(month.name[i]))
}

for (i in 9:12){
  sss_mes[,,i] = apply(sss[,, meses==i], MARGIN=c(1,2), FUN=mean, na.rm=TRUE)
  image.map(lon, lat, sss_mes[,,i], main=paste(month.name[i]))
}
```

Como se observa en la imagen superior la salinidad disminuye en los meses de marzo y abril y tiene la mayor salinidad en enero. A continuación se comparará la salinidad con la temperatura de ambos meses.

```{r , fig.width=8, fig.height=7, fig.cap=" Temperatura vs Salinidad ",echo=FALSE, fig.align="center"}

par(mfrow=c(2,2), mar=c(4,4,1,2))
image.map(lon, lat, sst_mes[,,1], main=paste(month.name[1]))
image.map(lon, lat, sss_mes[,,1], main=paste(month.name[1]))
image.map(lon, lat, sst_mes[,,4], main=paste(month.name[4]))
image.map(lon, lat, sss_mes[,,4], main=paste(month.name[4]))

```
Las bajas salinidades están asociadas a una disminución de la temperatura en el mes de abril, sin embargo, lo contrario ocurre en el mes de enero estas diferencias podrían estar asociadas a corrientes.

##Análisis de Producción primaria

###Promedio general de fitoplancton
```{r , fig.width=5, fig.height=5, fig.cap=" ",echo=FALSE, fig.align="center"}
par(oma=c(0,0,0,2))
image.map(lon, lat, promtodofito, main="Promedio total fitoplancton 1990", legend.lab = "µmol C m-2 s-1", legend.width = 0.5)
```


```{r , fig.width=8, fig.height=3, fig.cap=" Fitoplancton pequeño vs grande micromol/m2/s ",echo=FALSE, fig.align="center"}

par(mfrow=c(1,2), mar=c(4,4,1,2))

  image.map(lon, lat, promsphy90, main="Fitoplancton pequeño")
  image.map(lon, lat, promlphy90, main="Fitoplancton grande")




```

###Fitoplancton pequeño

```{r , fig.width=8, fig.height=7, fig.cap=" Fitoplancton pequeño micromol/m2/s ",echo=FALSE, fig.align="center"}
par(mfrow=c(4,3), mar=c(4,4,1,4))
meses = rep(1:12, length=length(t1990))
sphy_mes= array(dim=c(dim(sfito)[1:2], 12)) 

for (i in 1:12){
  sphy_mes[,,i] = apply(sfito[,, meses==i], MARGIN=c(1,2), FUN=mean, na.rm=TRUE)
  image.map(lon, lat, sphy_mes[,,i], main=paste(month.name[i]))
}



```
###Fitoplancton grande
```{r , fig.width=8, fig.height=7, fig.cap=" Fitoplancton grande micromol/m2/s ",echo=FALSE, fig.align="center"}
par(mfrow=c(4,3), mar=c(4,4,1,4))
meses = rep(1:12, length=length(t1990))
lphy_mes= array(dim=c(dim(lfito)[1:2], 12)) 

for (i in 1:12){
  lphy_mes[,,i] = apply(lfito[,, meses==i], MARGIN=c(1,2), FUN=mean, na.rm=TRUE)
  image.map(lon, lat, lphy_mes[,,i], main=paste(month.name[i]))
}



```
Como se mencionó previamente la producción primaria en las costas peruanas es impulsada por las surgencias de aguas profundas que como se mostró en los gráficos de temperatura era más evidente en los meses de verano. Por ello se grafica la siguiente figura con la producción de fitoplancton total (pequeño y grande) en los meses de verano.


## Conclusiones



## Referencias

